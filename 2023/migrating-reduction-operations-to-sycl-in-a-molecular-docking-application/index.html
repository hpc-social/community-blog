<!DOCTYPE html>
<html lang="en-US" data-theme="light">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Migrating reduction operations to SYCL in a molecular docking application - hpc.social - Community Syndicated Blog</title>
        <meta name="description" content="Shared community experiences and stories">
        <meta name="keywords" content="">
        <base href="https://hpc.social/community-blog" />
        
        <meta content="2023-08-10T22:30:31-06:00" property="article:published_time">
        <meta content="https://hpc.social/about/" property="article:author">
          
        <meta property="og:site_name" content="hpc.social - Community Syndicated Blog">
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://hpc.social/community-blog/2023/migrating-reduction-operations-to-sycl-in-a-molecular-docking-application/"/>
        <meta property="og:title" content="Migrating reduction operations to SYCL in a molecular docking application - hpc.social - Community Syndicated Blog" />
        <meta property="og:description" content="Shared community experiences and stories" />
        <meta property="og:image" content="https://hpc.social/community-blog/assets/images/hpc-social-blue.png"/>
        <meta name="twitter:site" content="@hpc_social" />
        <meta name="twitter:creator" content="@hpc_social" /> 
        <meta name="twitter:card" content="summary"/>
        <meta property="twitter:title" content="Migrating reduction operations to SYCL in a molecular docking application - hpc.social - Community Syndicated Blog" />
        <meta property="twitter:description" content="Shared community experiences and stories" />
        <meta property="twitter:image" content="https://hpc.social/community-blog/assets/images/hpc-social-blue.png" />
        <link rel="stylesheet" href="/community-blog/assets/css/highlight.css">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Catamaran:wght@300&display=swap" rel="stylesheet"> 

        <link rel="stylesheet" href="/community-blog/assets/css/style.css">
        <link rel="shortcut icon" href="/community-blog/assets/images/hpc-social-blue.png" />
        <link rel="alternate" type="application/atom+xml" title="hpc.social - Community Syndicated Blog" href="https://hpc.social/community-blog/atom.xml">
        <link rel="alternate" type="application/json" title="hpc.social - Community Syndicated Blog" href="https://hpc.social/community-blog/feed.json" />
        <link rel="sitemap" type="application/xml" title="sitemap" href="https://hpc.social/community-blog/sitemap.xml" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","author":{"@type":"Person","name":"hpc.social"},"description":"Shared community experiences and stories","headline":"hpc.social - Community Syndicated Blog","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://hpc.social/community-blog/assets/images/hpc-social-blue.png"},"name":"hpc.social"},"sameAs":["https://twitter.com/","https://github.com/"],"url":"https://hpc.social/community-blog"}</script>
    </head>
<body>

<div class="container">
	<div class="profile">
		<a href="https://hpc.social/community-blog/"><img src="/community-blog/assets/images/hpc-social-blue.png" class="profile-image"></a>
		<div class="profile-about">
			<h2 style="margin-bottom: 0; font-weight: 700;">hpc.social</h2>
			
			
				<a href="https://twitter.com/hpc_social" target="_blank"><img src="/community-blog/assets/images/icon/twitter.svg" class="social-icon"></a>
			
			
			
			
				<a href="https://github.com/hpc-social" target="_blank"><img src="/community-blog/assets/images/icon/github.svg" class="social-icon"></a>
			
			
			<a href="/community-blog/about/"><img src="/community-blog/assets/images/icon/me.svg" class="social-icon"></a>
			<br>
			High Performance Computing <br> Practitioners and friends <br> Community Syndicated Blog <br>
			<br>
			<div class="mode" id="mode-switcher" onclick="toggleNightMode();">
				<span></span>
			</div>
		</div>
	</div>
	
<div class="post-header">
	<div class="post-date">10.08.2023  &middot; <span class="reading-time" title="Estimated read time">
  
   9 mins  read </span>
</div>
	<div class="post-share">
		Share:&nbsp; 
		<a href="https://twitter.com/intent/tweet?source=tweetbutton&amp;original_referer=https://hpc.social/migrating-reduction-operations-to-sycl-in-a-molecular-docking-application&amp;text=Migrating reduction operations to SYCL in a molecular docking application - https://hpc.social/migrating-reduction-operations-to-sycl-in-a-molecular-docking-application" target="_blank"><img src="https://hpc.social/community-blog/assets/images/icon/twitter.svg" class="social-icon"></a>
	</div>
</div>

<div class="tags-container" style="padding:10px; font-size:18px; font-style:italic">
        This is a crosspost from &nbsp; <a target="_blank" href="https://dev.to/oneapi">DEV Community: oneAPI Community</a>&nbsp;The latest articles on DEV Community by oneAPI Community (@oneapi)..&nbsp;See the original post&nbsp;<a target="_blank" href="https://dev.to/oneapi/migrating-reduction-operations-to-sycl-in-a-molecular-docking-application-5fkp">here</a>.</div>

<div class="blog-post-content">
	<h1>Migrating reduction operations to SYCL in a molecular docking application</h1>
	<p>I completed porting of a molecular docking application from CUDA to SYCL using the Intel® DPC++ Compatibility Tool (Compatibility Tool) in June 2021. Let me share selected techniques that I used without delving into the details of the docking application. If you want to learn how to use this tool to migrate CUDA applications to SYCL, please refer to [1].</p>

<p>The Compatibility Tool adds comments in the code where manual migration may be required. Typically, the manual changes required fall into two categories. First, changes are required for the code to compile and make the code functionally correct. Other changes are necessary to get better performance. Here, I will cover code that uses the operation of 'reduction'. Reductions are frequently used in High Performance Computing and scientific applications and can be performance hotspots. The first example finds the sum of integers and the second finds the minimum of floats and the identifier of the run that corresponds to the minimum.</p>

<h2>
  
  
  Integer Reductions to find the number of evaluations
</h2>

<p>The  docking application performs integer reductions to keep a running count of the number of score evaluations. This reduction is  implemented as a multi-line macro in CUDA as shown below.<br />
</p>

<div class="highlight js-code-highlight">
<pre class="highlight cuda"><code><span class="cp">#define REDUCEINTEGERSUM(value, pAccumulator)     
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>     
    <span class="p">{</span>     
        <span class="o">*</span><span class="n">pAccumulator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     
    <span class="p">}</span>     
    <span class="n">__threadfence</span><span class="p">();</span>     
    <span class="n">__syncthreads</span><span class="p">();</span>     
    <span class="k">if</span> <span class="p">(</span><span class="n">__any_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>     
    <span class="p">{</span>     
        <span class="kt">uint32_t</span> <span class="n">tgx</span>            <span class="o">=</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">cData</span><span class="p">.</span><span class="n">warpmask</span><span class="p">;</span>     
        <span class="n">value</span>                  <span class="o">+=</span> <span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tgx</span> <span class="o">^</span> <span class="mi">1</span><span class="p">);</span>     
        <span class="n">value</span>                  <span class="o">+=</span> <span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tgx</span> <span class="o">^</span> <span class="mi">2</span><span class="p">);</span>     
        <span class="n">value</span>                  <span class="o">+=</span> <span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tgx</span> <span class="o">^</span> <span class="mi">4</span><span class="p">);</span>     
        <span class="n">value</span>                  <span class="o">+=</span> <span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tgx</span> <span class="o">^</span> <span class="mi">8</span><span class="p">);</span>     
        <span class="n">value</span>                  <span class="o">+=</span> <span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tgx</span> <span class="o">^</span> <span class="mi">16</span><span class="p">);</span>     
        <span class="k">if</span> <span class="p">(</span><span class="n">tgx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>     
        <span class="p">{</span>     
            <span class="n">atomicAdd</span><span class="p">(</span><span class="n">pAccumulator</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>     
        <span class="p">}</span>     
    <span class="p">}</span>     
    <span class="n">__threadfence</span><span class="p">();</span>     
    <span class="n">__syncthreads</span><span class="p">();</span>     
    <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">pAccumulator</span><span class="p">;</span>     
    <span class="n">__syncthreads</span><span class="p">();</span>
</code></pre>

</div>

<p>Let us review what this code is doing:</p>

<ul>
<li>The code is called for each work item (thread) in a work group (warp)</li>
<li>
<em>*pAccumulator</em> is where the final sum is stored summing across all work items</li>
<li>The combination of <em>__threadfence()</em> and <em>__syncthreads()</em> guarantees memory consistency and synchronizes threads in the warp at the point of the call.</li>
<li>The <em>__any_sync()</em> call executes the block for those non-exited threads for which <em>'value != 0'</em>
</li>
<li>The following <em>__shfl_sync</em> calls do a tree-wise summing with the final sum available in the first thread in the warp in variable <em>value</em>
</li>
<li>The <em>value</em> is then added to the Accumulator atomically with <em>atomicAdd</em> and finally all threads assign the sum to the <em>value</em> variable.</li>
</ul>

<p>For more details about these CUDA calls please refer to [2].</p>

<p>The Compatibility tool was not able to automatically migrate this code with the following comments.<br />
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>/*
DPCT1023:40: The DPC++ sub-group does not support mask options for sycl::ext::oneapi::any_of.

DPCT1023:41: The DPC++ sub-group does not support mask options for shuffle.

DPCT1007:39: Migration of this CUDA API is not supported by the Intel(R) DPC++ Compatibility Tool.
*/
</code></pre>

</div>

<p>However, SYCL supports a rich set of functions for performing reductions. In this case, the reduce_over_group() function in SYCL can be used to create the same functionality as the above code as follows.<br />
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>
#define REDUCEINTEGERSUM(value, pAccumulator)     
        int val = sycl::reduce_over_group(item_ct1.get_group(), value, std::plus&lt;&gt;());      
        *pAccumulator = val;     
        item_ct1.barrier(sycl::access::fence_space::local_space);
</code></pre>

</div>

<p>The <em>sycl::reduce_over_group</em> is a collective function. The usage of this function simplifies the macro. The function takes the group, the value to be reduced, and the reduction operation which in this case is plus or summation. The function can adapt to varied sizes of work groups in SYCL and will use the best available optimizations available per the compiler and run-time.</p>

<h2>
  
  
  Finding the minimum energy
</h2>

<p>In another part of the application, a block of CUDA threads perform shuffles to find the minimum of scores <em>v0</em> and the corresponding identifier <em>k0</em> of the run in the simulation that is the minimum score. The CUDA code calls a macro WARPMINIMUM2 (not shown) which in turn calls another macro WARPMINIMUMEXCHANGE (shown) with <em>mask</em> set to 1, 2, 4, 8, and 16.<br />
</p>

<div class="highlight js-code-highlight">
<pre class="highlight cuda"><code><span class="cp">#define WARPMINIMUMEXCHANGE(tgx, v0, k0, mask)     
</span>    <span class="p">{</span>     
        <span class="kt">float</span> <span class="n">v1</span>    <span class="o">=</span> <span class="n">v0</span><span class="p">;</span>     
        <span class="kt">int</span> <span class="n">k1</span>      <span class="o">=</span> <span class="n">k0</span><span class="p">;</span>     
        <span class="kt">int</span> <span class="n">otgx</span>    <span class="o">=</span> <span class="n">tgx</span> <span class="o">^</span> <span class="n">mask</span><span class="p">;</span>     
        <span class="kt">float</span> <span class="n">v2</span>    <span class="o">=</span> <span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">otgx</span><span class="p">);</span>     
        <span class="kt">int</span> <span class="n">k2</span>      <span class="o">=</span> <span class="n">__shfl_sync</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">otgx</span><span class="p">);</span>     
        <span class="kt">int</span> <span class="n">flag</span>    <span class="o">=</span> <span class="p">((</span><span class="n">v1</span> <span class="o">&lt;</span> <span class="n">v2</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">tgx</span> <span class="o">&gt;</span> <span class="n">otgx</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">v1</span> <span class="o">!=</span> <span class="n">v2</span><span class="p">);</span>     
        <span class="n">k0</span>          <span class="o">=</span> <span class="n">flag</span> <span class="o">?</span> <span class="n">k1</span> <span class="o">:</span> <span class="n">k2</span><span class="p">;</span>     
        <span class="n">v0</span>          <span class="o">=</span> <span class="n">flag</span> <span class="o">?</span> <span class="n">v1</span> <span class="o">:</span> <span class="n">v2</span><span class="p">;</span>     
    <span class="p">}</span>
</code></pre>

</div>

<p>The <em>__shfl_sync</em> provides a way of moving a value from one thread to other threads in the warp in one instruction. In this code snippet <em>__shfl_sync</em> gets the <em>v0</em> or <em>k0</em> value from the thread identified by the <em>otgx</em> mask and saves it in <em>v2</em>, <em>k2</em> variables. We then compare <em>v1</em> with <em>v2</em> to set <em>flag</em> and eventually store the minimum in <em>v0</em> and the run identifier for this minimum in <em>k0</em>.</p>

<p>Compatibility Tool could not completely migrate this code and included this comment as the reason it could not. However, Compatibility Tool correctly replaced the <em>__shfl_sync</em> call with SYCL <em>shuffle</em> call as shown in the below diff which shows the manual change.<br />
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>/*
DPCT1023:57: The DPC++ sub-group does not support mask options for shuffle.
*/
</code></pre>

</div>

<p>This comment indicates that the <em>shuffle</em> call in SYCL does not use a mask as shown below.<br />
</p>

<div class="highlight js-code-highlight">
<pre class="highlight diff"><code><span class="err">#define</span> WARPMINIMUMEXCHANGE(tgx, v0, k0, mask)     
        {     
                float v1 = v0;     
                int k1 = k0;     
                int otgx = tgx ^ mask;     
<span class="gd">-               float v2 = item_ct1.get_sub_group().shuffle(energy, otgx);     
</span><span class="gi">+               float v2 = item_ct1.get_sub_group().shuffle(v0, otgx);  
</span><span class="gd">-               int k2 = item_ct1.get_sub_group().shuffle(bestID, otgx);     
</span><span class="gi">+               int k2 = item_ct1.get_sub_group().shuffle(k0, otgx);     
</span>                int flag = ((v1 &lt; v2) ^ (tgx &gt; otgx)) &amp;&amp; (v1 != v2);     
                k0 = flag ? k1 : k2;     
                v0 = flag ? v1 : v2;     
        }
</code></pre>

</div>

<p>In this case, Compatibility Tool performed incorrect variable substitution for <em>v0</em> and <em>k0</em> in the shuffle calls using <em>energy</em> and <em>bestID</em> variables from the caller function. We manually fixed this by replacing <em>energy</em> with <em>v0</em> and <em>bestID</em> with <em>k0</em>. This bug has been fixed in recent versions of the Compatibility Tool.</p>

<h2>
  
  
  Summary
</h2>

<p>In summary, reduction operations in CUDA applications may not be migrated correctly by the Compatibility Tool. Review the comments provided by the tool to understand if manual migration is necessary and what change might be required. A good understanding of the original CUDA code will then help to make manual changes to develop functionally correct code in SYCL.</p>

<p>[1] <a href="https://www.intel.com/content/www/us/en/docs/dpcpp-compatibility-tool/get-started-guide/2023-1/overview.html">https://www.intel.com/content/www/us/en/docs/dpcpp-compatibility-tool/get-started-guide/2023-1/overview.html</a></p>

<p>[2] <a href="https://developer.nvidia.com/blog/using-cuda-warp-level-primitives/">https://developer.nvidia.com/blog/using-cuda-warp-level-primitives/</a></p>

</div>
<div class="tags-container">
	
</div>
<style>
#uppy {
  position: fixed;
  bottom: 50px;
  right: 50px;
  z-index: 99;
  border: none;
  outline: none;
  background-color: darkturquoise;
  color: black;
  cursor: pointer;
  margin:15px;
  border-radius: 10px;
  width: 100px;
  height: 20px;
}

#returnTop:hover {
  background-color: #555;
}
</style>

<button id="uppy" title="Return to Top" class="btn btn-lg">Back to top</button>

<script>
(function() {

var scrollTop = function() {
    window.scrollTo(0, 0);
};

document.getElementById('uppy').onclick = scrollTop;

})();
</script>


<div class="navigation">
	
		<a class="prev" href="/community-blog/2023/iwomp-2023/">< IWOMP 2023</a>
	 
	<a class="next" href="/community-blog/2023/iwomp-2023/">IWOMP 2023 ></a>

</div>

	<div class="footer">
		<span style="padding-right:10px"><font color="red">©️ </font><a href="https://hpc.social"><b>hpc.social</b> community</a></span> 
		| <a style="padding-left:10px; padding-right:10px" href="/community-blog/archive/">Archive</a>
		| <a style="padding-left:10px; padding-right:10px" href="/community-blog/">Posts</a>
		| <a style="padding-left:10px; padding-right:10px" href="/community-blog/about/">About</a>
		| <a style="padding-left:10px; padding-right:10px" href="https://hpc.social/blog">hpc.social blogs</a>
		| <a style="padding-left:37%;" target="_blank" href="https://github.com/hpc-social/community-blog">Add Your Blog</a>
	</div>
</div>
    <script src="/community-blog/assets/scripts.js"></script>
    <script type="text/javascript">
        if (localStorage.theme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
            document.getElementById('mode-switcher').classList.add('active');
        } else if (localStorage.theme === 'dark' || localStorage.theme === '' || (!('theme' in localStorage))) {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('mode-switcher').classList.add('active');
        }
    </script>
</body>
</html>

